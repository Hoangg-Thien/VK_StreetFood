<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:VK.Mobile.ViewModels"
             xmlns:models="clr-namespace:VK.Mobile.Models"
             x:Class="VK.Mobile.Views.AnalyticsPage"
             x:DataType="vm:AnalyticsViewModel"
             Title="Thá»‘ng kÃª"
             BackgroundColor="{StaticResource PageBackground}">

    <RefreshView IsRefreshing="{Binding IsLoading}"
                 Command="{Binding LoadCommand}">
        <ScrollView>
            <VerticalStackLayout Spacing="0"
                                 Padding="0,0,0,20">

                <!-- Header banner -->
                <Grid HeightRequest="80"
                      Margin="16,16,16,0">
                    <Grid.Background>
                        <LinearGradientBrush StartPoint="0,0"
                                             EndPoint="1,1">
                            <GradientStop Color="#FF5722"
                                          Offset="0"/>
                            <GradientStop Color="#FF8A65"
                                          Offset="1"/>
                        </LinearGradientBrush>
                    </Grid.Background>
                    <VerticalStackLayout VerticalOptions="Center"
                                         Margin="16,0">
                        <Label Text="ðŸ“Š HÃ nh trÃ¬nh cá»§a báº¡n"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="White"/>
                        <Label Text="KhÃ¡m phÃ¡ áº©m thá»±c Ä‘Æ°á»ng phá»‘ VÄ©nh KhÃ¡nh"
                               FontSize="12"
                               TextColor="#FFCCBC"/>
                    </VerticalStackLayout>
                </Grid>

                <!-- Error state -->
                <Frame IsVisible="{Binding HasError}"
                       Margin="16,16,16,0"
                       Padding="16"
                       BackgroundColor="#FFF3E0"
                       BorderColor="#FF8A00"
                       CornerRadius="12">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="{Binding ErrorMessage}"
                               TextColor="#E65100"
                               FontSize="14"/>
                        <Button Text="Thá»­ láº¡i"
                                Command="{Binding RetryCommand}"
                                BackgroundColor="#FF5722"
                                TextColor="White"
                                HeightRequest="40"
                                CornerRadius="8"/>
                    </VerticalStackLayout>
                </Frame>

                <!-- ===== Thá»‘ng kÃª cÃ¡ nhÃ¢n ===== -->
                <Label Text="ðŸ™‹ Thá»‘ng kÃª cá»§a tÃ´i"
                       FontSize="16"
                       FontAttributes="Bold"
                       TextColor="{StaticResource TextPrimary}"
                       Margin="20,20,16,8"/>

                <Grid ColumnDefinitions="*,*"
                      RowDefinitions="Auto,Auto"
                      Margin="16,0"
                      ColumnSpacing="12"
                      RowSpacing="12">

                    <!-- LÆ°á»£t thÄƒm -->
                    <Frame Grid.Row="0"
                           Grid.Column="0"
                           Padding="12"
                           CornerRadius="12"
                           BackgroundColor="{StaticResource CardBackground}"
                           BorderColor="Transparent">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="ðŸ—ºï¸"
                                   FontSize="24"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding TotalVisits}"
                                   FontSize="28"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"
                                   HorizontalOptions="Center"/>
                            <Label Text="LÆ°á»£t thÄƒm"
                                   FontSize="12"
                                   TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Nghe audio -->
                    <Frame Grid.Row="0"
                           Grid.Column="1"
                           Padding="12"
                           CornerRadius="12"
                           BackgroundColor="{StaticResource CardBackground}"
                           BorderColor="Transparent">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="ðŸŽ§"
                                   FontSize="24"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding TotalAudioPlays}"
                                   FontSize="28"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"
                                   HorizontalOptions="Center"/>
                            <Label Text="Láº§n nghe"
                                   FontSize="12"
                                   TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- QR Scan -->
                    <Frame Grid.Row="1"
                           Grid.Column="0"
                           Padding="12"
                           CornerRadius="12"
                           BackgroundColor="{StaticResource CardBackground}"
                           BorderColor="Transparent">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="ðŸ“·"
                                   FontSize="24"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding TotalQRScans}"
                                   FontSize="28"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"
                                   HorizontalOptions="Center"/>
                            <Label Text="QR quÃ©t"
                                   FontSize="12"
                                   TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Thá»i gian nghe -->
                    <Frame Grid.Row="1"
                           Grid.Column="1"
                           Padding="12"
                           CornerRadius="12"
                           BackgroundColor="{StaticResource CardBackground}"
                           BorderColor="Transparent">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="â±ï¸"
                                   FontSize="24"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding TotalAudioTime}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}"
                                   HorizontalOptions="Center"/>
                            <Label Text="ÄÃ£ nghe"
                                   FontSize="12"
                                   TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <!-- Chi tiáº¿t thÃªm -->
                <Frame Margin="16,12,16,0"
                       Padding="16"
                       CornerRadius="12"
                       BackgroundColor="{StaticResource CardBackground}"
                       BorderColor="Transparent">
                    <VerticalStackLayout Spacing="10">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label Text="ðŸ“"
                                   Grid.Column="0"
                                   FontSize="18"
                                   VerticalOptions="Center"/>
                            <Label Text="Äiá»ƒm nghe nhiá»u nháº¥t"
                                   Grid.Column="1"
                                   Margin="8,0"
                                   TextColor="{StaticResource TextSecondary}"
                                   VerticalOptions="Center"/>
                            <Label Text="{Binding MostVisitedPOI}"
                                   Grid.Column="2"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextPrimary}"
                                   VerticalOptions="Center"/>
                        </Grid>
                        <BoxView HeightRequest="1"
                                 Color="{StaticResource Border}"/>
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label Text="ðŸŒ"
                                   Grid.Column="0"
                                   FontSize="18"
                                   VerticalOptions="Center"/>
                            <Label Text="NgÃ´n ngá»¯ yÃªu thÃ­ch"
                                   Grid.Column="1"
                                   Margin="8,0"
                                   TextColor="{StaticResource TextSecondary}"
                                   VerticalOptions="Center"/>
                            <Label Text="{Binding FavoriteLanguage}"
                                   Grid.Column="2"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextPrimary}"
                                   VerticalOptions="Center"/>
                        </Grid>
                        <BoxView HeightRequest="1"
                                 Color="{StaticResource Border}"/>
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label Text="ðŸ“¡"
                                   Grid.Column="0"
                                   FontSize="18"
                                   VerticalOptions="Center"/>
                            <Label Text="Geofence enter"
                                   Grid.Column="1"
                                   Margin="8,0"
                                   TextColor="{StaticResource TextSecondary}"
                                   VerticalOptions="Center"/>
                            <Label Text="{Binding TotalGeofenceEnters}"
                                   Grid.Column="2"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource TextPrimary}"
                                   VerticalOptions="Center"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- ===== Top POIs ===== -->
                <Label Text="ðŸ† Top Ä‘iá»ƒm tham quan"
                       FontSize="16"
                       FontAttributes="Bold"
                       TextColor="{StaticResource TextPrimary}"
                       Margin="20,24,16,8"/>

                <!-- Empty state -->
                <Label Text="ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª"
                       IsVisible="{Binding TopPOIs.Count, Converter={StaticResource IntToBoolInvertedConverter}}"
                       HorizontalOptions="Center"
                       TextColor="{StaticResource TextSecondary}"
                       Margin="0,20"/>

                <CollectionView ItemsSource="{Binding TopPOIs}"
                                Margin="16,0"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:TopPOIModel">
                            <Frame Margin="0,0,0,10"
                                   Padding="12"
                                   CornerRadius="12"
                                   BackgroundColor="{StaticResource CardBackground}"
                                   BorderColor="Transparent">
                                <Grid ColumnDefinitions="Auto,*,Auto"
                                      ColumnSpacing="12">
                                    <!-- Rank badge -->
                                    <Frame Grid.Column="0"
                                           WidthRequest="40"
                                           HeightRequest="40"
                                           BackgroundColor="#FFF3E0"
                                           BorderColor="Transparent"
                                           CornerRadius="20"
                                           Padding="0">
                                        <Label Text="{Binding VisitCount}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="#FF5722"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"/>
                                    </Frame>

                                    <!-- Info -->
                                    <VerticalStackLayout Grid.Column="1"
                                                         Spacing="2"
                                                         VerticalOptions="Center">
                                        <Label Text="{Binding Name}"
                                               FontSize="15"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextPrimary}"
                                               LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding CategoryName}"
                                               FontSize="12"
                                               TextColor="{StaticResource TextSecondary}"/>
                                        <Label FontSize="11"
                                               TextColor="{StaticResource TextSecondary}">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="ðŸŽ§ "/>
                                                    <Span Text="{Binding AudioPlayCount}"/>
                                                    <Span Text=" láº§n nghe Â· â­ "/>
                                                    <Span Text="{Binding AverageRating, StringFormat='{0:F1}'}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </VerticalStackLayout>

                                    <!-- Avg listen time -->
                                    <VerticalStackLayout Grid.Column="2"
                                                         VerticalOptions="Center">
                                        <Label Text="{Binding AverageListenMinutes, StringFormat='{0:F1}m'}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Primary}"
                                               HorizontalOptions="End"/>
                                        <Label Text="avg"
                                               FontSize="10"
                                               TextColor="{StaticResource TextSecondary}"
                                               HorizontalOptions="End"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
