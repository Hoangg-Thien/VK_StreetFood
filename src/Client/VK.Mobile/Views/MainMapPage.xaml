<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:VK.Mobile.ViewModels"
             xmlns:loc="clr-namespace:VK.Mobile.Services"
             xmlns:models="clr-namespace:VK.Mobile.Models"
             x:Class="VK.Mobile.Views.MainMapPage"
             x:DataType="vm:MainMapViewModel"
             Title="VK Street Food">

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Top Bar -->
        <Grid Grid.Row="0"
              Padding="10"
              BackgroundColor="#FF5722">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Label Grid.Column="0"
                   Text="{Binding Source={x:Static loc:LocalizationResourceManager.Instance}, Path=[MapTitle]}"
                   FontSize="20"
                   FontAttributes="Bold"
                   TextColor="White"
                   VerticalOptions="Center"/>

            <Picker Grid.Column="1"
                    Title="{Binding Source={x:Static loc:LocalizationResourceManager.Instance}, Path=[Language]}"
                    SelectedIndex="{Binding SelectedLanguageIndex}"
                    TextColor="White"
                    TitleColor="White"
                    WidthRequest="130"
                    Margin="10,0"
                    SelectedIndexChanged="OnLanguageChanged">
                <Picker.ItemsSource>
                    <x:Array Type="{x:Type x:String}">
                        <x:String>Tiáº¿ng Viá»‡t</x:String>
                        <x:String>English</x:String>
                        <x:String>í•œêµ­ì–´</x:String>
                    </x:Array>
                </Picker.ItemsSource>
            </Picker>

            <Button Grid.Column="2"
                    Text="ðŸ“·"
                    FontSize="24"
                    BackgroundColor="Transparent"
                    WidthRequest="44"
                    HeightRequest="44"
                    Clicked="OnQRScanClicked"/>
        </Grid>

        <!-- Map + POI List -->
        <Grid Grid.Row="1">
            <!-- Map Container -->
            <ContentView x:Name="MapContainer"/>

            <!-- POI List Drawer (Bottom) -->
            <Frame VerticalOptions="End"
                   Margin="8,0,8,8"
                   Padding="0"
                   CornerRadius="12"
                   BackgroundColor="White"
                   HasShadow="True"
                   MaximumHeightRequest="200"
                   IsVisible="{Binding HasPOIs}">
                <VerticalStackLayout>
                    <Label Text="{Binding Source={x:Static loc:LocalizationResourceManager.Instance}, Path=[POIListTitle]}"
                           FontSize="14"
                           FontAttributes="Bold"
                           Padding="12,8,12,4"
                           TextColor="#333"/>
                    <CollectionView ItemsSource="{Binding Pois}"
                                    HeightRequest="150">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:POIModel">
                                <Grid ColumnDefinitions="*,Auto"
                                      Padding="12,6"
                                      ColumnSpacing="8">
                                    <VerticalStackLayout Grid.Column="0"
                                                         VerticalOptions="Center">
                                        <Label Text="{Binding Name}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="#333"
                                               LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding Address}"
                                               FontSize="11"
                                               TextColor="#888"
                                               LineBreakMode="TailTruncation"/>
                                    </VerticalStackLayout>
                                    <Button Grid.Column="1"
                                            Text="ðŸ”Š"
                                            FontSize="18"
                                            BackgroundColor="#FF5722"
                                            TextColor="White"
                                            CornerRadius="20"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            Padding="0"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainMapViewModel}}, Path=TestAudioCommand}"
                                            CommandParameter="{Binding .}"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           Color="#FF5722"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"/>

        <!-- Bottom Info Bar -->
        <Grid Grid.Row="2"
              Padding="10"
              BackgroundColor="White">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Label Grid.Column="0"
                   Text="ðŸ“"
                   FontSize="24"
                   VerticalOptions="Center"/>

            <StackLayout Grid.Column="1"
                         Spacing="2"
                         Margin="10,0">
                <Label FontSize="14"
                       FontAttributes="Bold">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="{Binding Source={x:Static loc:LocalizationResourceManager.Instance}, Path=[POIsLabel]}"/>
                            <Span Text=": "/>
                            <Span Text="{Binding Pois.Count}"/>
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
                <Label FontSize="12"
                       TextColor="Gray">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="{Binding Source={x:Static loc:LocalizationResourceManager.Instance}, Path=[NearbyLabel]}"/>
                            <Span Text=": "/>
                            <Span Text="{Binding NearbyPOIs.Count}"/>
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
            </StackLayout>

            <Frame Grid.Column="2"
                   Padding="8,4"
                   BackgroundColor="{Binding IsTracking, Converter={StaticResource BoolToColorConverter}}"
                   CornerRadius="12"
                   HasShadow="False">
                <Label Text="{Binding IsTracking, Converter={StaticResource BoolToTrackingTextConverter}}"
                       TextColor="White"
                       FontSize="12"/>
            </Frame>
        </Grid>

    </Grid>

</ContentPage>
